# Layer 8: Applications

## Overview

The Applications Layer provides user-facing apps for K??ra???a OS smart glasses. It includes 5 core apps (Timer, Navigation, Social, Settings, Wellness) with AR-native interfaces optimized for hands-free interaction.

## Architecture

```
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???                      LAYER 8: APPLICATIONS                               ???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???                                                                           ???
???  ????????????????????????????????????  ????????????????????????????????????  ????????????????????????????????????  ????????????????????????????????????  ???????????????????????????????????? ???
???  ???  Timer   ???  ???  Navi    ???  ???  Social  ???  ??? Settings ???  ??? Wellness ??? ???
???  ???  App     ???  ???  gation  ???  ???  Connect ???  ??? Control  ???  ???  Health  ??? ???
???  ????????????????????????????????????  ????????????????????????????????????  ????????????????????????????????????  ????????????????????????????????????  ???????????????????????????????????? ???
???       ???             ???             ???             ???             ???        ???
???       ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????        ???
???                               ???                                          ???
???                               ???                                          ???
???                   ??????????????????????????????????????????????????????????????????????????????                            ???
???                   ???   App Runtime          ???                            ???
???                   ???   Lifecycle | Storage  ???                            ???
???                   ??????????????????????????????????????????????????????????????????????????????                            ???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
```

## Core Applications

### 1. Timer App

**Purpose**: Set timers and stopwatches with voice/gesture control.

**Features**:
- Voice: "Set timer for 5 minutes"
- Gesture: Pinch + drag to adjust time
- Visual: AR countdown in view
- Audio: Chime when complete
- Haptic: Vibration alert

**Implementation**:
```typescript
class TimerApp {
  private timers: Map<string, Timer> = new Map();
  
  async start(duration: number, label?: string): Promise<string> {
    const id = crypto.randomUUID();
    const timer: Timer = {
      id,
      label,
      duration,
      startTime: Date.now(),
      endTime: Date.now() + duration * 1000,
      remaining: duration,
      paused: false,
    };
    
    this.timers.set(id, timer);
    
    // Create AR display
    this.createARTimer(timer);
    
    // Schedule completion
    setTimeout(() => this.onComplete(id), duration * 1000);
    
    return id;
  }
  
  private createARTimer(timer: Timer): void {
    const anchor = this.anchorManager.createAnchor({ x: 0.7, y: 0.3 }, 1.5);
    
    const element = new ARCard({
      title: timer.label || 'Timer',
      text: this.formatTime(timer.remaining),
    }, anchor.worldPosition);
    
    this.hud.addElement(timer.id, element);
    
    // Update every second
    setInterval(() => {
      timer.remaining = (timer.endTime - Date.now()) / 1000;
      element.update(this.formatTime(timer.remaining));
    }, 1000);
  }
  
  private onComplete(id: string): void {
    const timer = this.timers.get(id);
    if (!timer) return;
    
    // Audio alert
    this.audioManager.play('/sounds/timer-complete.mp3');
    
    // Haptic feedback
    navigator.vibrate([200, 100, 200]);
    
    // Visual notification
    this.hud.showNotification({
      title: 'Timer Complete',
      message: timer.label || 'Your timer has finished',
      duration: 5000,
    });
    
    // Remove from active timers
    this.timers.delete(id);
    this.hud.removeElement(id);
  }
}
```

---

### 2. Navigation App

**Purpose**: Turn-by-turn AR navigation with real-world overlay.

**Features**:
- Voice: "Navigate to work"
- AR arrows: Overlay navigation arrows on road
- Distance: "Turn left in 50 meters"
- ETA: Estimated arrival time
- Route: Alternative routes

**Implementation**:
```typescript
class NavigationApp {
  private activeRoute: Route | null = null;
  private currentStep = 0;
  
  async navigate(destination: string): Promise<void> {
    // 1. Geocode destination
    const destCoords = await this.geocode(destination);
    
    // 2. Get current location
    const origin = await this.getCurrentLocation();
    
    // 3. Calculate route
    this.activeRoute = await this.calculateRoute(origin, destCoords);
    
    // 4. Start turn-by-turn
    this.startNavigation();
  }
  
  private async calculateRoute(origin: LatLng, dest: LatLng): Promise<Route> {
    const response = await fetch(
      `https://api.mapbox.com/directions/v5/mapbox/driving/` +
      `${origin.lng},${origin.lat};${dest.lng},${dest.lat}?` +
      `geometries=geojson&access_token=${MAPBOX_TOKEN}`
    );
    
    const data = await response.json();
    const route = data.routes[0];
    
    return {
      distance: route.distance,
      duration: route.duration,
      steps: route.legs[0].steps,
      geometry: route.geometry,
    };
  }
  
  private startNavigation(): void {
    // Create AR arrow for first step
    this.showARArrow(this.activeRoute.steps[0]);
    
    // Monitor location
    navigator.geolocation.watchPosition((position) => {
      this.updateProgress(position.coords);
    });
  }
  
  private showARArrow(step: RouteStep): void {
    // Create 3D arrow
    const arrow = this.create3DArrow(step.maneuver.bearing);
    
    // Position 10 meters ahead
    const arrowPos = this.projectAhead(10, step.maneuver.bearing);
    
    const anchor = this.anchorManager.createAnchor(arrowPos, 10);
    this.arScene.addARObject(anchor.id, arrow);
    
    // Show instruction
    this.voiceOutput.speak(step.maneuver.instruction);
    this.hud.showNotification({
      title: step.maneuver.instruction,
      message: `in ${step.distance}m`,
      duration: 5000,
    });
  }
  
  private updateProgress(coords: Coordinates): void {
    // Check if passed current step
    const distanceToStep = this.distanceTo(coords, this.activeRoute.steps[this.currentStep]);
    
    if (distanceToStep < 5) { // Within 5 meters
      // Move to next step
      this.currentStep++;
      
      if (this.currentStep < this.activeRoute.steps.length) {
        this.showARArrow(this.activeRoute.steps[this.currentStep]);
      } else {
        this.onArrival();
      }
    }
  }
  
  private onArrival(): void {
    this.voiceOutput.speak('You have arrived at your destination');
    this.hud.showNotification({
      title: 'Arrived',
      message: 'You have reached your destination',
      duration: 5000,
    });
    
    this.activeRoute = null;
  }
}
```

---

### 3. Social App

**Purpose**: View and interact with social media hands-free.

**Features**:
- Notifications: See friend requests, mentions
- Feed: Scroll through social feed with gestures
- Post: Voice-to-text posting
- Messages: Read and reply to messages
- AR profiles: See profile cards in AR

**Implementation**:
```typescript
class SocialApp {
  private feed: Post[] = [];
  private currentPost = 0;
  
  async loadFeed(): Promise<void> {
    const response = await fetch('/api/social/feed', {
      headers: { 'Authorization': `Bearer ${this.authToken}` },
    });
    
    this.feed = await response.json();
    this.showPost(0);
  }
  
  private showPost(index: number): void {
    const post = this.feed[index];
    
    const card = new ARCard({
      title: post.author.name,
      text: post.content,
      image: post.images[0],
      timestamp: post.timestamp,
    }, new Vector3(0, 0, -1.5));
    
    this.hud.addElement('social-post', card);
  }
  
  nextPost(): void {
    this.currentPost = (this.currentPost + 1) % this.feed.length;
    this.showPost(this.currentPost);
  }
  
  previousPost(): void {
    this.currentPost = (this.currentPost - 1 + this.feed.length) % this.feed.length;
    this.showPost(this.currentPost);
  }
  
  async post(content: string): Promise<void> {
    await fetch('/api/social/post', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${this.authToken}` },
      body: JSON.stringify({ content }),
    });
    
    this.voiceOutput.speak('Your post has been published');
  }
  
  // Voice command: "Post: I'm having a great day!"
  async voicePost(transcript: string): Promise<void> {
    if (transcript.startsWith('Post: ')) {
      const content = transcript.substring(6);
      await this.post(content);
    }
  }
}
```

---

### 4. Settings App

**Purpose**: Configure system settings and preferences.

**Features**:
- Display: Brightness, contrast
- Audio: Volume, voice settings
- Network: WiFi, Bluetooth
- Privacy: Permissions, data
- System: Updates, diagnostics

**Implementation**:
```typescript
class SettingsApp {
  private settings: SystemSettings;
  
  async load(): Promise<void> {
    this.settings = await this.storageManager.get('system_settings');
    this.renderSettingsMenu();
  }
  
  private renderSettingsMenu(): void {
    const menu = {
      title: 'Settings',
      items: [
        { label: 'Display', icon: '????', action: () => this.showDisplaySettings() },
        { label: 'Audio', icon: '????', action: () => this.showAudioSettings() },
        { label: 'Network', icon: '????', action: () => this.showNetworkSettings() },
        { label: 'Privacy', icon: '????', action: () => this.showPrivacySettings() },
        { label: 'System', icon: '??????', action: () => this.showSystemSettings() },
      ],
    };
    
    this.hud.showMenu(menu);
  }
  
  private showDisplaySettings(): void {
    const settings = [
      {
        label: 'Brightness',
        type: 'slider',
        value: this.settings.display.brightness,
        min: 0,
        max: 100,
        onChange: (value) => this.setBrightness(value),
      },
      {
        label: 'Contrast',
        type: 'slider',
        value: this.settings.display.contrast,
        min: 0,
        max: 100,
        onChange: (value) => this.setContrast(value),
      },
    ];
    
    this.hud.showSettings('Display Settings', settings);
  }
  
  private async setBrightness(value: number): Promise<void> {
    this.settings.display.brightness = value;
    await this.storageManager.set('system_settings', this.settings);
    
    // Apply to hardware
    this.hardwareManager.setDisplayBrightness(value / 100);
  }
}
```

---

### 5. Wellness App

**Purpose**: Track health metrics and provide wellness insights.

**Features**:
- Heart rate: Real-time monitoring
- Steps: Daily step count
- Calories: Burned calories
- Sleep: Sleep quality tracking
- Stress: Stress level detection
- Reminders: Hydration, posture

**Implementation**:
```typescript
class WellnessApp {
  private metrics: HealthMetrics;
  
  async initialize(): Promise<void> {
    // Start continuous monitoring
    this.startMonitoring();
    
    // Show dashboard
    this.renderDashboard();
  }
  
  private startMonitoring(): void {
    // Heart rate (every 5 seconds)
    setInterval(async () => {
      this.metrics.heartRate = await this.healthSensor.getHeartRate();
      this.updateDashboard('heartRate', this.metrics.heartRate);
    }, 5000);
    
    // Steps (every minute)
    setInterval(async () => {
      this.metrics.steps = await this.healthSensor.getSteps('today');
      this.updateDashboard('steps', this.metrics.steps);
    }, 60000);
    
    // Check for anomalies
    this.monitorAnomalies();
  }
  
  private renderDashboard(): void {
    const dashboard = {
      title: 'Wellness',
      widgets: [
        {
          type: 'gauge',
          label: 'Heart Rate',
          value: this.metrics.heartRate,
          unit: 'bpm',
          range: [60, 100],
        },
        {
          type: 'progress',
          label: 'Steps',
          value: this.metrics.steps,
          goal: 10000,
          unit: 'steps',
        },
        {
          type: 'chart',
          label: 'Calories',
          data: this.metrics.caloriesHistory,
          unit: 'kcal',
        },
      ],
    };
    
    this.hud.showDashboard(dashboard);
  }
  
  private monitorAnomalies(): void {
    setInterval(() => {
      // High heart rate
      if (this.metrics.heartRate > 120 && !this.isExercising()) {
        this.hud.showAlert({
          type: 'warning',
          title: 'Elevated Heart Rate',
          message: 'Your heart rate is higher than normal. Consider taking a break.',
        });
      }
      
      // Sedentary reminder (no steps in 1 hour)
      const lastStepTime = this.metrics.lastStepTimestamp;
      if (Date.now() - lastStepTime > 3600000) {
        this.voiceOutput.speak('You\'ve been sitting for a while. Consider taking a short walk.');
      }
    }, 60000);
  }
}
```

---

## App Runtime

**App Lifecycle**:
```typescript
enum AppState {
  STOPPED = 'STOPPED',
  STARTING = 'STARTING',
  RUNNING = 'RUNNING',
  PAUSED = 'PAUSED',
  STOPPING = 'STOPPING',
}

class AppRuntime {
  private apps: Map<string, App> = new Map();
  private activeApp: App | null = null;
  
  async launch(appId: string): Promise<void> {
    const app = this.apps.get(appId);
    if (!app) throw new Error(`App not found: ${appId}`);
    
    app.state = AppState.STARTING;
    
    // Initialize app
    await app.initialize();
    
    // Show app UI
    app.render();
    
    app.state = AppState.RUNNING;
    this.activeApp = app;
  }
  
  async close(appId: string): Promise<void> {
    const app = this.apps.get(appId);
    if (!app) return;
    
    app.state = AppState.STOPPING;
    
    // Cleanup
    await app.cleanup();
    
    app.state = AppState.STOPPED;
    
    if (this.activeApp === app) {
      this.activeApp = null;
    }
  }
  
  pause(appId: string): void {
    const app = this.apps.get(appId);
    if (app && app.state === AppState.RUNNING) {
      app.onPause();
      app.state = AppState.PAUSED;
    }
  }
  
  resume(appId: string): void {
    const app = this.apps.get(appId);
    if (app && app.state === AppState.PAUSED) {
      app.onResume();
      app.state = AppState.RUNNING;
    }
  }
}
```

---

## Performance Metrics

```
?????? Applications Performance ????????????????????????????????????????????????
??? App Launch Time: 200-500ms               ???
??? UI Rendering: 16ms (60 FPS)              ???
??? Timer Accuracy: ??50ms                    ???
??? Navigation Update: 1s intervals          ???
??? Social Feed Load: 500-1000ms            ???
??? Settings Apply: <100ms                   ???
??? Wellness Monitoring: 5s intervals        ???
???                                           ???
??? Memory Usage:                             ???
???   Timer: 5 MB                             ???
???   Navigation: 50 MB                       ???
???   Social: 30 MB                           ???
???   Settings: 2 MB                          ???
???   Wellness: 10 MB                         ???
???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
```

---

## Future Development

### Phase 1: More Apps (Q1 2026)
- Email client
- Calendar
- Notes
- Music player
- Camera

### Phase 2: App Store (Q2 2026)
- Third-party app SDK
- App marketplace
- App reviews & ratings
- Monetization

### Phase 3: AI Integration (Q3 2026)
- Smart suggestions
- Context-aware apps
- Predictive actions
- Personalization

### Phase 4: Cross-Device (Q4 2026)
- Sync with phone/tablet
- Handoff between devices
- Cloud storage
- Multi-device control

---

## Code References

- `simulator-ui/apps/TimerApp.tsx`: Timer implementation
- `simulator-ui/apps/NavigationApp.tsx`: Navigation
- `karana-core/src/apps/`: App runtime (Rust)

---

## Summary

Layer 8 provides:
- **5 Core Apps**: Timer, Navigation, Social, Settings, Wellness
- **AR-Native UI**: Optimized for hands-free interaction
- **Voice Control**: Natural language commands
- **App Runtime**: Lifecycle management
- **Performance**: 60 FPS rendering, <500ms launch time

This layer delivers practical, everyday functionality for smart glasses.
